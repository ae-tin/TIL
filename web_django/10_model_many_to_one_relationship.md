# N:1 Relationship

### Relationship?

> 데이터베이스 내 여러 테이블 간의 논리적인 연결 관계를 나타냄

- 테이블 간 관계를 표현하기 위해 한 테이블에 다른 테이블의 기본 키(PK)를 저장하며, 이처럼 다른 테이블의 기본 키를 참조하는 속성을 외래 키 (FK)라고 한다

- 외래키는 논리적인 연결 고리 이며 관계형 데이터베이스에서 연관된 데이터를 효율적으로 관리할 수 있다

## N:1(Many to One)

> 여러 개의 레코드가 하나의 레코드와 연결됨
> 
> > 여러 교육생(N)을 한 강사(1)가 가르침
> > 
> > 여러 코멘트(N)가 한 게시물(1)에 달림

## 테이블 관계 설정

- 관계 설정을 위한 FK를 N:1에서 1을 담당하는 테이블에 위치하면 안됨. 중복으로인해 낭비

- 적절한 위치는 N을 담당하는 테이블에 위치
  
  - 외래 키 컬럼에 저장되는 데이터는 참조하는 데이터를 대표하는 PK 정보를 저장함
  
  - Comment가 생성되면 Article의 정보만 FK로 저장하면 됨

## ForeignKey 필드 in Django

`ForeignKey(to, on_delete)`

> 한 모델이 다른 모델을 참조하는 관계를 설정하는 필드

- N:1 관계 표현할 때 사용

- 데이터 베이스에서 외래키로 구현됨

- `to` > 참조하는 모델 class 이름 (N:1 중 1의 class 정보)

- `on_delete` > 삭제 되었을 때 행동
  
  - 게시글이 삭제되었을 때 댓글들을 어떻게 할거냐에 대한 것

### on_delete 속성 종류

`CASCADE`

- 참조 된 객체(부모 객체)가 삭제 될 때 이를 참조하는 모든 객체도 삭제되도록 지정

- 게시글이 삭제되면 해당 게시글의 모든 댓글 삭제

`PROTECT`

- 삭제 하려는 부모 객체에 자식 객체가 존재한다면 해당 부모 객체를 삭제하지 못하도록 지정

- 게시글을 삭제할 때 해당 게시글에 댓글이 존재하면 게시글 삭제 불가

`SET_NULL`

- 부모 객체가 삭제되면, 해당 필드에 값이 NULL이 저장되도록 지정

- 단, 해당 FK필드 설정이 null=True가 설정되어야함

## 특정 게시글(Article)의 댓글(Comment) 정보 조회하기

- QuerySet API의 .all() 사용하기 -> 불가
  
  - 특정 게시글의 댓글들이 아닌 모든 댓글 정보를 가져오게 됨

- QuerySet API의 .filter() 사용하기
  
  - 특정 게시글 정보를 조회 후 댓글에서 filter를 활용해 댓글 조회 가능
    
    - `article = Article.objects.get(pk=1)`
    
    - `comments = Comment.objects.filter(article=article)`
    
    - > 하지만 이건 좀 어색함

### 역참조

> 누가 나를 참조하는지 거꾸로 조회 하는 것

`article.comment_set.all()`

`모델인스턴스.related manager(역참조 이름).QuerySet API`

1. 모델 인스턴스
   
   - models.py 에 정의된 모델 클래스로 생성된 실제 데이터를 의미
     
     - 'article.title'과 같이 속성에 접근 가능하며 속성을 수정할 수 있음
   
   - 역참조에서는 참조 가능한 필드가 없는 모델 클래스의 인스턴스를 사용하면 됨
     
     - 특정 게시글에 작성된 댓글 전체를 조회하는 요청

2. related manager(역참조 이름)
   
   - related manager 라고 부르며 N:1 or N:M 관계에서 역참조 시에 사용하는 매니저를 의미
   
   - objects 매니저를 통해 QuerySet API를 사용했던 것 처럼 related manager를 통해 QuerySet API를 사용할 수 있게 됨
   
   - `모델 클래스명 + _set` 이 기본 값이며 Django에서 자동으로 생성해 줌
   
   - 관계를 직접 정의하지 않은 모델에서 연결된 객체들을 조회할 수 있게 함

3. QuerySet API
   
   - 데이터를 가져오기 위한 쿼리 결과 집합을 만드는 인터페이스
   
   - SQL 쿼리를 직접 쓰지 않고도 DB를 사용할 수 있음
